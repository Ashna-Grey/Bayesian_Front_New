<!DOCTYPE html>
<html>

<head>
    <title>Adaptive Authentication Login</title>
</head>

<body>

<h2>Login</h2>

<input id="email" placeholder="Email"><br><br>
<input id="password" type="password" placeholder="Password"><br><br>

<button onclick="login()">Login</button>

<br><br>

<div id="otpBox" style="display:none;">
    <input id="otp" placeholder="Enter OTP">
    <button onclick="verifyOTP()">Verify OTP</button>
</div>

<p id="result"></p>

<script>

//////////////////////////////////////////////////
// MOUSE TRACKING
//////////////////////////////////////////////////

let mouseData = [];

document.addEventListener("mousemove", (e) => {

    mouseData.push({
        x: e.clientX,
        y: e.clientY,
        t: Date.now()
    });

    // keep recent movements only
    if (mouseData.length > 200) {
        mouseData.shift();
    }
});

//////////////////////////////////////////////////
// LOGIN FUNCTION
//////////////////////////////////////////////////

async function login(){

    if(!navigator.geolocation){
        alert("Location not supported");
        return;
    }

    navigator.geolocation.getCurrentPosition(
        async (position) => {

            try{

                const response = await fetch(
                    "https://bayesian-new.onrender.com/login",
                    {
                        method:"POST",
                        headers:{
                            "Content-Type":"application/json"
                        },
                        body:JSON.stringify({
                            email:document.getElementById("email").value,
                            password:document.getElementById("password").value,
                            latitude:position.coords.latitude,
                            longitude:position.coords.longitude,
                            mouse: mouseData
                        })
                    }
                );

                const data = await response.json();

                console.log("LOGIN RESPONSE:", data);

                if(data.decision === "ENTER_OTP"){
                    document.getElementById("otpBox").style.display = "block";
                    document.getElementById("result").innerText =
                        "OTP sent to registered email.";
                }
                else{
                    document.getElementById("result").innerText =
                        "Login failed.";
                }

            }
            catch(err){
                console.error(err);
                alert("Backend not reachable");
            }
        }
    );
}

//////////////////////////////////////////////////
// OTP VERIFY
//////////////////////////////////////////////////

async function verifyOTP(){

    try{

        const response = await fetch(
            "https://bayesian-new.onrender.com/verify-otp",
            {
                method:"POST",
                headers:{
                    "Content-Type":"application/json"
                },
                body:JSON.stringify({
                    email:document.getElementById("email").value,
                    otp:document.getElementById("otp").value
                })
            }
        );

        const data = await response.json();

        console.log("OTP RESPONSE:", data);

        if(data.confidence !== undefined){

            document.getElementById("result").innerText =
                "Login Successful\nConfidence Score: "
                + Number(data.confidence).toFixed(3);

            // reset mouse data after login
            mouseData = [];
        }
        else{
            document.getElementById("result").innerText =
                "OTP verification failed";
        }

    }
    catch(err){
        console.error(err);
        alert("OTP verification error");
    }
}

</script>

</body>
</html>